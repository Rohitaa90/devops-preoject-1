pipeline {
    agent any
    
    environment {
        FRONTEND_IMAGE = "portfolio-frontend"
        BACKEND_IMAGE = "portfolio-backend"
        NGINX_IMAGE = "portfolio-nginx"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code...'
                checkout scm
            }
        }
        
        stage('Build Images') {
            parallel {
                stage('Build Frontend') {
                    steps {
                        script {
                            echo 'Building Frontend Docker Image...'
                            bat "docker build -t ${FRONTEND_IMAGE}:${BUILD_NUMBER} ./frontend"
                            bat "docker tag ${FRONTEND_IMAGE}:${BUILD_NUMBER} ${FRONTEND_IMAGE}:latest"
                        }
                    }
                }
                
                stage('Build Backend') {
                    steps {
                        script {
                            echo 'Building Backend Docker Image...'
                            bat "docker build -t ${BACKEND_IMAGE}:${BUILD_NUMBER} ./backend"
                            bat "docker tag ${BACKEND_IMAGE}:${BUILD_NUMBER} ${BACKEND_IMAGE}:latest"
                        }
                    }
                }
                
                stage('Build Nginx') {
                    steps {
                        script {
                            echo 'Building Nginx Docker Image...'
                            bat "docker build -t ${NGINX_IMAGE}:${BUILD_NUMBER} ./nginx"
                            bat "docker tag ${NGINX_IMAGE}:${BUILD_NUMBER} ${NGINX_IMAGE}:latest"
                        }
                    }
                }
            }
        }
        
        stage('Test') {
            steps {
                script {
                    echo 'Running health checks...'
                    bat '''
                        docker run -d --name test-backend -p 4001:4000 %BACKEND_IMAGE%:latest
                        timeout /t 5 /nobreak
                        curl http://localhost:4001/health || exit 1
                        docker stop test-backend
                        docker rm test-backend
                    '''
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    echo 'Deploying containers...'
                    bat 'docker-compose down || exit 0'
                    bat 'docker-compose up -d'
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                script {
                    echo 'Verifying deployment...'
                    bat 'timeout /t 10 /nobreak'
                    bat 'curl http://localhost:4000/health'
                    bat 'curl http://localhost:3000'
                }
            }
        }
    }
    
    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
        always {
            echo 'Cleaning up...'
            bat 'docker image prune -f'
        }
    }
}
